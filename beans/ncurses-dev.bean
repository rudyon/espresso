#!/bin/bash

# Check if script is run as root
if [ "$(id -u)" -ne "0" ]; then
    echo "This script must be run as root."
    exit 1
fi

echo "Installing ncurses-dev..."

# Ensure /etc/espresso directory exists
mkdir -p /etc/espresso

# Define version and download URLs
NCURSES_VERSION="6.5"
NCURSES_TAR="ncurses-${NCURSES_VERSION}.tar.gz"
NCURSES_URL="https://ftp.gnu.org/gnu/ncurses/${NCURSES_TAR}"

# Download ncurses source code
echo "Downloading ncurses ${NCURSES_VERSION} source code..."
wget $NCURSES_URL -O /etc/espresso/$NCURSES_TAR || { echo "Error downloading ncurses source code"; exit 1; }

# Extract the tarball
echo "Extracting ncurses source code..."
tar -xf /etc/espresso/$NCURSES_TAR -C /etc/espresso || { echo "Error extracting ncurses tarball"; exit 1; }

# Change directory to ncurses
cd /etc/espresso/ncurses-${NCURSES_VERSION} || { echo "Error changing directory to ncurses-${NCURSES_VERSION}"; exit 1; }

# Configure and install ncurses
echo "Configuring ncurses..."
./configure --prefix=/usr/local || { echo "Error configuring ncurses"; exit 1; }

echo "Building ncurses..."
make || { echo "Error building ncurses"; exit 1; }

echo "Installing ncurses..."
make install || { echo "Error installing ncurses"; exit 1; }

# Verify ncurses installation
if [ ! -f /usr/local/include/curses.h ]; then
    echo "Error: ncurses installation did not complete successfully. Header file 'curses.h' is missing."
    exit 1
fi

echo "Brewed ncurses-dev. Your coffee is ready. â˜•"

# Reconfigure and build nano
cd /etc/espresso/nano-8.1 || { echo "Error changing directory to nano-8.1"; exit 1; }
echo "Reconfiguring and building nano with ncurses-dev..."
CFLAGS="-I/usr/local/include" LDFLAGS="-L/usr/local/lib" ./configure --prefix=/usr/local || { echo "Error configuring nano"; exit 1; }
make || { echo "Error building nano"; exit 1; }
make install || { echo "Error installing nano"; exit 1; }

echo "Installation complete!"

